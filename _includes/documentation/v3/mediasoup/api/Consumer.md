## Consumer
{: #Consumer}

<section markdown="1">

A consumer represents an audio or video source being forwarded from a mediasoup router to an endpoint. It's created on top of a transport that defines how the media packets are carried.

</section>


### Dictionaries
{: #Consumer-dictionaries}

<section markdown="1">

#### ConsumerOptions
{: #ConsumerOptions .code}

<div markdown="1" class="table-wrapper L3">

Field           | Type    | Description   | Required | Default
--------------- | ------- | ------------- | -------- | ---------
`producerId`    | String  | The id of the producer to consume. | Yes |
`rtpCapabilities` | [RtpCapabilities](/documentation/v3/mediasoup/rtp-parameters-and-capabilities/#RtpCapabilities) | RTP capabilities of the consuming endpoint. | Yes |
`paused`        | Boolean | Whether the consumer must start in paused mode. See note below. | No | `false`
`preferredLayers` | [ConsumerLayers](#ConsumerLayers) | Preferred spatial and temporal layer for simulcast or SVC media sources. If unset, the highest ones are selected. | No |
`enableRtx`     | Boolean | Whether this Consumer should enable RTP retransmissions, storing sent RTP and processing the incoming RTCP NACK from the remote Consumer. If set to `true`, NACK will be enabled if both endpoints (mediasoup and the remote Consumer) support NACK for the codec. When in audio just OPUS supports NACK. | No | `true` for video codecs, `false` for audio codecs
`ignoreDtx`     | Boolean | Whether this consumer should ignore DTX packets (only valid for Opus codec). If set, DTX packets are not forwarded to the remote consumer. | No | `false`
`pipe`          | Boolean | Whether this consumer should consume all RTP streams generated by the producer instead of consuming a single and continuos RTP stream (same behavior as when consuming in a pipe transport, in which this setting is always implicit). | No | `false`
`mid`           | String  | The MID for the Consumer. If not specified, a sequentially growing number will be assigned. | No |
`appData`       | [AppData](#AppData) | Custom application data. | No | `{ }`

</div>

<div markdown="1" class="note">
Check the [RTP Parameters and Capabilities](/documentation/v3/mediasoup/rtp-parameters-and-capabilities/) section for more details.
</div>

#### ConsumerLayers
{: #ConsumerLayers .code}

<div markdown="1" class="table-wrapper L3">

Field           | Type    | Description   | Required | Default
--------------- | ------- | ------------- | -------- | ---------
`spatialLayer`  | Number  | The spatial layer index (from 0 to N). | Yes |
`temporalLayer` | Number  | The temporal layer index (from 0 to N). | No |

</div>

#### ConsumerScore
{: #ConsumerScore .code}

<div markdown="1" class="table-wrapper L3">

Field           | Type    | Description   | Required | Default
--------------- | ------- | ------------- | -------- | ---------
`score`         | Number  | Score of the RTP stream in the consumer (from 0 to 10) representing its transmission quality. | Yes |
`producerScore` | Number  | Score of the currently selected RTP stream in the associated producer (from 0 to 10) representing its transmission quality. | Yes |
`producerScores` | Array&lt;Number&gt;  | The scores of all RTP streams in the producer ordered by encoding (just useful when the producer uses simulcast). | Yes |

</div>

#### ConsumerTraceEventData
{: #ConsumerTraceEventData .code}

<div markdown="1" class="table-wrapper L3">

Field              | Type    | Description   | Required | Default
------------------ | ------- | ------------- | -------- | ---------
`type`             | [ConsumerTraceEventType](#ConsumerTraceEventType) | Trace event type. | Yes |
`timestamp`        | Number  | Event timestamp. | Yes | 
`direction`        | String  | "in" (icoming direction) or "out" (outgoing direction). | Yes |
`info`             | Object  | Per type specific information. | Yes |

</div>

<div markdown="1" class="note">
See also "trace" Event in the [Debugging](/documentation/v3/mediasoup/debugging#trace-Event) section.
</div>

</section>


### Enums
{: #Consumer-enums}

<section markdown="1">

#### ConsumerType
{: #ConsumerType .code}

<div markdown="1" class="table-wrapper L2">

Value          | Description  
-------------- | -------------
"simple"       | A single RTP stream is sent with no spatial/temporal layers.
"simulcast"    | Two or more RTP streams are sent, each of them with one or more temporal layers.
"svc"          | A single RTP stream is sent with spatial/temporal layers.
"pipe"         | Special type for consumers created on a [PipeTransport](#PipeTransport).

</div>

#### ConsumerTraceEventType
{: #ConsumerTraceEventType .code}

<div markdown="1" class="table-wrapper L2">

Value          | Description
-------------- | -------------
"rtp"          | RTP packet.
"keyframe"     | RTP video keyframe packet.
"nack"         | RTCP NACK packet.
"pli"          | RTCP PLI packet.
"fir"          | RTCP FIR packet.

</div>

</section>


### Properties
{: #Consumer-properties}

<section markdown="1">

#### consumer.id
{: #consumer-id .code}

Consumer identifier.

> `@type` String, read only

#### consumer.producerId
{: #consumer-producerId .code}

The associated producer identifier.

> `@type` String, read only

#### consumer.closed
{: #consumer-closed .code}

Whether the consumer is closed.

#### consumer.kind
{: #consumer-kind .code}

The media kind ("audio" or "video").

> `@type` [MediaKind](/documentation/v3/mediasoup/rtp-parameters-and-capabilities/#MediaKind), read only

#### consumer.rtpParameters
{: #consumer-rtpParameters .code}

Consumer RTP parameters.

> `@type` [RtpReceiveParameters](/documentation/v3/mediasoup/rtp-parameters-and-capabilities/#RtpReceiveParameters), read only

<div markdown="1" class="note">
Check the [RTP Parameters and Capabilities](/documentation/v3/mediasoup/rtp-parameters-and-capabilities/) section for more details.
</div>

#### consumer.type
{: #consumer-type .code}

Consumer type.

> `@type` [ConsumerType](#ConsumerType), read only

#### consumer.paused
{: #consumer-paused .code}

Whether the consumer is paused. It does not take into account whether the associated producer is paused.

> `@type` Boolean, read only

#### consumer.producerPaused
{: #consumer-producerPaused .code}

Whether the associated producer is paused.

> `@type` Boolean, read only

#### consumer.score
{: #consumer-score .code}

The score of the RTP stream being sent, representing its tranmission quality. 

> `@type` [ConsumerScore](#ConsumerScore), read only

#### consumer.preferredLayers
{: #consumer-preferredLayers .code}

Preferred spatial and temporal layers (see [setPreferredLayers()](#consumer-setPreferredLayers) method). For simulcast and SVC consumers, `undefined` otherwise.

> `@type` [ConsumerLayers](#ConsumerLayers)\|Undefined, read only

#### consumer.currentLayers
{: #consumer-currentLayers .code}

Currently active spatial and temporal layers (for simulcast and SVC consumers only). It's `undefined` if no layers are being sent to the consuming endpoint at this time (or if the consumer is consuming from a simulcast or svc producer).

> `@type` [ConsumerLayers](#ConsumerLayers)\|Undefined, read only

#### consumer.priority
{: #consumer-priority .code}

Consumer priority (see [setPriority()](#consumer-setPriority) method).

> `@type` Number, read only

#### consumer.appData
{: #consumer-appData .code}

Custom data provided by the application in the worker factory method. The app can modify it at any time.

> `@type` [AppData](#AppData)

#### consumer.observer
{: #consumer-observer .code}

See the [Observer Events](#Consumer-observer-events) section below.

> `@type` [EventEmitter](https://nodejs.org/api/events.html#events_class_eventemitter), read only

</section>


### Methods
{: #Consumer-methods}

<section markdown="1">

#### consumer.close()
{: #consumer-close .code}

Closes the consumer.

#### consumer.getStats()
{: #consumer-getStats .code}

Returns current RTC statistics of the consumer.

> `@async`
> 
> `@returns` Array&lt;ConsumerStat&gt;

<div markdown="1" class="note">
Check the [RTC Statistics](/documentation/v3/mediasoup/rtc-statistics/) section for more details.
</div>

#### consumer.pause()
{: #consumer-pause .code}

Pauses the consumer (no RTP is sent to the consuming endpoint).

> `@async`

#### consumer.resume()
{: #consumer-resume .code}

Resumes the consumer (RTP is sent again to the consuming endpoint).

> `@async`

#### consumer.setPreferredLayers(preferredLayers)
{: #consumer-setPreferredLayers .code}

Sets the preferred (highest) spatial and temporal layers to be sent to the consuming endpoint. Just valid for simulcast and SVC consumers.

<div markdown="1" class="table-wrapper L3">

Argument   | Type    | Description | Required | Default 
---------- | ------- | ----------- | -------- | ----------
`preferredLayers` | [ConsumerLayers](#ConsumerLayers) | Preferred spatial and temporal layers. The temporal layer is optional (if unset, the highest one is chosen). | Yes |

</div>

> `@async`

```javascript
await consumer.setPreferredLayers({ spatialLayer: 3 });
```

#### consumer.setPriority(priority)
{: #consumer-setPriority .code}

Sets the priority for this consumer. It affects how the estimated outgoing bitrate in the transport (obtained via transport-cc or REMB) is distributed among all video consumers, by priorizing those with higher priority.

<div markdown="1" class="table-wrapper L3">

Argument   | Type    | Description | Required | Default 
---------- | ------- | ----------- | -------- | ----------
`priority` | Number  | From 1 (minimum) to 255 (maximum). | Yes |

</div>

> `@async`

<div markdown="1" class="note">
Consumers' priority is only appreciable when there is not enough estimated outgoing bitrate to satisfy the needs of all video consumers.
</div>

```javascript
await consumer.setPriority(2);
```

#### consumer.unsetPriority()
{: #consumer-unsetPriority .code}

Unsets the priority for this consumer (it sets it to its default value 1).

> `@async`

```javascript
await consumer.unsetPriority();
```

#### consumer.requestKeyFrame()
{: #consumer-requestKeyFrame .code}

Request a key frame to the associated producer. Just valid for video consumers.

> `@async`

#### consumer.enableTraceEvent(types)
{: #consumer-enableTraceEvent .code}

Instructs the consumer to emit "trace" events. For monitoring purposes. Use with caution.

<div markdown="1" class="table-wrapper L3">

Argument    | Type    | Description | Required | Default 
----------- | ------- | ----------- | -------- | ----------
`types`     | Array&lt;[ConsumerTraceEventType](#ConsumerTraceEventType)&gt; | Enabled types. | No | Unset (so disabled)

</div>

> `@async`

```javascript
await consumer.enableTraceEvent([ "rtp", "pli", "fir" ]);

consumer.on("trace", (trace) =>
{
  // trace.type can be "rtp" or "pli" or "fir".
});
```

</section>


### Events
{: #Consumer-events}

<section markdown="1">

#### consumer.on("transportclose", fn())
{: #consumer-on-transportclose .code}

Emitted when the transport this consumer belongs to is closed for whatever reason. The consumer itself is also closed.

```javascript
consumer.on("transportclose", () =>
{
  console.log("transport closed so consumer closed");
});
```

#### consumer.on("producerclose", fn())
{: #consumer-on-producerclose .code}

Emitted when the associated producer is closed for whatever reason. The consumer itself is also closed.

```javascript
consumer.on("producerclose", () =>
{
  console.log("associated producer closed so consumer closed");
});
```

#### consumer.on("producerpause", fn())
{: #consumer-on-producerpause .code}

Emitted when the associated producer is paused.

#### consumer.on("producerresume", fn())
{: #consumer-on-producerresume .code}

Emitted when the associated producer is resumed.

#### consumer.on("score", fn(score))
{: #consumer-on-score .code}

Emitted when the consumer score changes.

<div markdown="1" class="table-wrapper L3">

Argument  | Type    | Description   
--------- | ------- | ----------------
`score`   | [ConsumerScore](#ConsumerScore) | RTP stream score.

</div>

#### consumer.on("layerschange", fn(layers))
{: #consumer-on-layerschange .code}

Emitted when the spatial/temporal layers being sent to the endpoint change. Just for simulcast or SVC consumers.

<div markdown="1" class="table-wrapper L3">

Argument  | Type    | Description   
--------- | ------- | ----------------
`layers`   | [ConsumerLayers](#ConsumerLayers)\|Undefined | Current spatial and temporal layers (or `undefined` if there are no current layers).

</div>

<div markdown="1" class="note">
This event is emitted under various circumstances in SVC or simulcast consumers (assuming the consumer endpoints supports BWE via REMB or Transport-CC):

* When the consumer (or its associated producer) is paused.
* When all the RTP streams of the associated producer become inactive (no RTP received for a while).
* When the available bitrate of the BWE makes the consumer upgrade or downgrade the spatial and/or temporal layers.
* When there is no available bitrate for this consumer (even for the lowest layers) so the event fires with `null` as argument.

The Node.js application can detect the latter (consumer deactivated due to not enough bandwidth) by checking if both `consumer.paused` and `consumer.producerPaused` are falsy after the consumer has emitted this event with `null` as argument.
</div>

#### consumer.on("trace", fn(trace))
{: #consumer-on-trace .code}

See [enableTraceEvent()](#consumer-enableTraceEvent) method.

<div markdown="1" class="table-wrapper L3">

Argument    | Type    | Description   
----------- | ------- | ----------------
`trace`    | [ConsumerTraceEventData](#ConsumerTraceEventData) | Trace data.

</div>

```javascript
consumer.on("trace", (trace) =>
{
  console.log(trace);
});
```

#### consumer.on("rtp", fn(rtpPacket))
{: #consumer-on-rtp .code}

Emitted when the consumer receives through its router a RTP packet from the associated producer.

<div markdown="1" class="note">
Just available in direct transports, this is, those created via `router.createDirectTransport()`.
</div>

<div markdown="1" class="table-wrapper L3">

Argument    | Type    | Description   
----------- | ------- | ----------------
`rtpPacket` | Buffer  | Received RTP packet. It's always a Node.js Buffer.

</div>

```javascript
consumer.on("rtp", (rtpPacket) =>
{
  // Do stuff with the binary RTP packet.
});
```

#### consumer.on("listenererror", fn(eventName, error))
{: #consumer-on-listenererror .code}

Emitted when an event listener given by the application throws. The exception is silently ignored internally to not break the internal state. By listening to this event, the application can be aware of exceptions happening in its given event listeners.

<div markdown="1" class="table-wrapper L3">

Argument    | Type    | Description   
----------- | ------- | ----------------
`eventName` | String  | The name of the event.
`error`     | Error   | The error happening in the application given event listener.

</div>

</section>


### Observer Events
{: #Consumer-observer-events}

<section markdown="1">

<div markdown="1" class="note">
See the [Observer API](#observer-api) section below.
</div>

#### consumer.observer.on("close", fn())
{: #consumer-observer-on-close .code}

Emitted when the consumer is closed for whatever reason.

#### consumer.observer.on("pause", fn())
{: #consumer-observer-on-pause .code}

Emitted when the consumer or its associated producer is paused and, as result, the consumer becomes paused.

#### consumer.observer.on("resume", fn())
{: #consumer-observer-on-resume .code}

Emitted when the consumer or its associated producer is resumed and, as result, the consumer is no longer paused.

#### consumer.observer.on("score", fn(score))
{: #consumer-observer-on-score .code}

Same as the [score](#consumer-on-score) event.

#### consumer.observer.on("layerschange", fn(layers))
{: #consumer-observer-on-layerschange .code}

Same as the [layerschange](#consumer-on-layerschange) event.

#### consumer.observer.on("trace", fn(trace))
{: #consumer-observer-on-trace .code}

Same as the [trace](#consumer-on-trace) event.

</section>
